# Workflow automatique de synchronisation des benchmarks depuis Google Sheets
#
# Pour activer ce workflow :
# 1. Renommer ce fichier en supprimant le .example : sync-benchmarks.yml
# 2. Remplacer YOUR_GOOGLE_SHEET_ID par votre ID de Google Sheet
# 3. S'assurer que le Google Sheet est accessible publiquement (Anyone with the link â†’ Viewer)
# 4. Commit et push

name: Sync Benchmarks from Google Sheets

on:
  # DÃ©clenchement manuel depuis l'interface GitHub Actions
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'Custom commit message (optional)'
        required: false
        default: 'chore: Auto-sync benchmarks from Google Sheets'

  # DÃ©clenchement automatique tous les lundis Ã  9h (UTC)
  # Pour dÃ©sactiver, commenter la section ci-dessous
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9:00 UTC

jobs:
  sync-benchmarks:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Download CSV from Google Sheets
        run: |
          SHEET_ID="1Q6U5y8GLPnY4QZcoRgbJkAGq9LJ20YmXXU1KvJ7NWuQ"

          echo "ðŸ“¥ Downloading from Google Sheets (ID: $SHEET_ID)..."
          curl -L "https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv" \
            -o data/benchmarks.csv

          # VÃ©rifier que le fichier n'est pas vide
          if [ ! -s data/benchmarks.csv ]; then
            echo "âŒ Error: Downloaded CSV is empty"
            exit 1
          fi

          echo "âœ… CSV downloaded successfully"
          wc -l data/benchmarks.csv

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: âš™ï¸ Generate TypeScript from CSV
        run: |
          echo "âš™ï¸ Generating TypeScript..."
          npm run generate:benchmarks

      - name: ðŸ” Check for changes
        id: check_changes
        run: |
          if git diff --quiet data/; then
            echo "No changes detected"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in data/"
            echo "changed=true" >> $GITHUB_OUTPUT
            git diff --stat data/
          fi

      - name: ðŸ’¾ Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/benchmarks.csv data/retailBenchmarks.ts

          COMMIT_MSG="${{ github.event.inputs.commit_message }}"
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="chore: Auto-sync benchmarks from Google Sheets"
          fi

          git commit -m "$COMMIT_MSG"
          git push

      - name: ðŸ“ Summary
        if: always()
        run: |
          echo "## ðŸ“Š Benchmark Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "âœ… **Changes detected and committed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Modified files:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            git diff HEAD~1 --stat data/ >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The Google Sheet data matches the current repository state." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Benchmark Stats:" >> $GITHUB_STEP_SUMMARY
          echo "- Total rows in CSV: $(wc -l < data/benchmarks.csv)" >> $GITHUB_STEP_SUMMARY
          echo "- Google Sheet: https://docs.google.com/spreadsheets/d/1Q6U5y8GLPnY4QZcoRgbJkAGq9LJ20YmXXU1KvJ7NWuQ/edit" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Cleanup on failure
        if: failure()
        run: |
          echo "## âŒ Sync Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Common issues:**" >> $GITHUB_STEP_SUMMARY
          echo "- Google Sheet is not publicly accessible" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid SHEET_ID in workflow file" >> $GITHUB_STEP_SUMMARY
          echo "- CSV validation failed (low >= median or median >= high)" >> $GITHUB_STEP_SUMMARY
